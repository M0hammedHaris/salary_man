# Story 4.2: Bill Payment Reminders

**Status:** Draft

## Story
**As a** user,
**I want** to receive timely reminders for credit card payments and other recurring bills,
**so that** I never miss payment due dates and avoid late fees or credit score impacts.

## Acceptance Criteria

1. Bill reminder system for credit card due dates with configurable advance notice (1, 3, 7, 14 days)
2. Recurring bill setup with custom frequencies (weekly, monthly, quarterly, annual) and amounts
3. Multiple reminder notifications leading up to due dates with escalating urgency
4. Bill payment tracking with status updates (pending, paid, overdue) and payment history
5. Integration with account balances to warn about insufficient funds for upcoming bills
6. Customizable reminder preferences per bill type with different notification channels
7. Automatic reminder adjustment for weekends and holidays using business day calculations
8. Bill payment confirmation system allowing users to mark bills as paid directly from notifications

## Dev Notes

### Previous Story Insights
Story 4.1 implemented comprehensive credit card usage alerts with multi-channel notification infrastructure (in-app, email, push notifications), alert service patterns for business logic encapsulation, and real-time integration with transaction processing. The alert infrastructure includes alert history tracking, acknowledgment systems, and dashboard integration patterns that can be leveraged for bill reminder functionality. The notification provider and alert center components provide established patterns for notification management.

### Data Models
Based on the current database schema [Source: src/lib/db/schema.ts]:

**Recurring Payments Data Model:** The `recurringPayments` table provides the foundation:
- `id: uuid` - Unique recurring payment identifier
- `userId: text` - Payment owner for user-scoped data
- `accountId: uuid` - Account charged for recurring payment
- `name: text` - Bill name (e.g., "Credit Card Payment", "Utilities")
- `amount: numeric` - Expected payment amount with financial precision
- `frequency: paymentFrequencyEnum` - Payment frequency (weekly, monthly, quarterly, yearly)
- `nextDueDate: timestamp` - Next expected payment date for reminder calculations
- `categoryId: uuid` - Category for automatic transaction categorization
- `isActive: boolean` - Whether bill is still active
- `lastProcessed: timestamp` - Last time payment was detected/processed

**Existing Alert Infrastructure:** Reuse `alerts` and `alertSettings` tables:
- `alertType` enum needs extension for bill reminder types
- `alerts` table for tracking reminder notifications sent
- `alertSettings` table for per-bill reminder preferences

**New Bill Reminder Data Model Required:**
- Extension of `alertType` enum to include bill reminder types
- Bill reminder settings for customizable advance notice periods
- Bill payment status tracking (pending, paid, overdue)
- Holiday calendar integration for business day calculations

### API Specifications
New API endpoints needed [Source: docs/architecture/architecture.md#api-specification]:

**GET /api/bills** - Retrieve user's recurring bills and payment status
**POST /api/bills** - Create new recurring bill setup
**PUT /api/bills/[id]** - Update bill details and reminder preferences
**DELETE /api/bills/[id]** - Deactivate recurring bill
**POST /api/bills/[id]/mark-paid** - Mark bill as paid with payment confirmation
**GET /api/bills/reminders** - Get upcoming bill reminders and due dates
**POST /api/bills/reminders/settings** - Update reminder preferences per bill

Authentication via Clerk JWT tokens following existing pattern [Source: docs/architecture/architecture.md#api-specification]

### Component Specifications
Following existing component patterns and alert infrastructure [Source: src/components/alerts/ structure]:

**Bill Management Components:**
- `src/components/bills/bill-center.tsx` - Main bill management dashboard
- `src/components/bills/bill-setup-form.tsx` - New bill creation/editing form
- `src/components/bills/bill-reminder-settings.tsx` - Reminder preference configuration
- `src/components/bills/upcoming-bills.tsx` - Dashboard widget for upcoming bills
- `src/components/bills/payment-confirmation.tsx` - Bill payment marking component

**Integration Points:**
- Extend `src/components/alerts/notification-provider.tsx` for bill reminder notifications
- Update `src/components/dashboard/dashboard-summary.tsx` to show upcoming bills
- Integrate with existing `src/components/alerts/alert-center.tsx` for unified notification management
- Enhance navigation to include bills management

### File Locations
Based on existing project structure and alert infrastructure patterns:
- Database schema updates: `src/lib/db/schema.ts` (extend alertType enum)
- New migration: `drizzle/migrations/` for bill reminder enhancements
- API routes: `src/app/api/bills/` directory
- Bill services: `src/lib/services/bill-service.ts` (following alert-service.ts patterns)
- Bill components: `src/components/bills/` directory
- Bill utilities: `src/lib/utils/bill-utils.ts` (date calculations, holiday logic)
- Business day utilities: `src/lib/utils/business-day-utils.ts` for holiday handling

### Testing Requirements
Following existing testing patterns [Source: src/__tests__/ structure]:
- Unit tests: `src/__tests__/components/bills/` for component testing
- API tests: `src/__tests__/api/bills/` for endpoint testing
- Service tests: `src/__tests__/lib/services/bill-service.test.ts`
- Utility tests: `src/__tests__/lib/utils/bill-utils.test.ts`, `src/__tests__/lib/utils/business-day-utils.test.ts`
- Integration tests for bill reminder triggering and payment confirmation workflows

### Technical Constraints
[Source: docs/architecture/architecture.md#tech-stack]:
- Use Drizzle ORM for database operations with type safety
- Follow Clerk authentication patterns for secured endpoints
- Use Zod for API request/response validation
- Implement using Next.js 15 App Router structure
- Utilize existing Tailwind CSS and shadcn/ui components
- Use Decimal.js or numeric precision for financial calculations
- Follow existing error handling and validation patterns
- Leverage existing notification infrastructure from Story 4.1

### Bill Reminder Implementation
[Source: docs/architecture/architecture.md#platform-infrastructure and Story 4.1 infrastructure]:
- **Cron jobs:** Utilize Vercel Cron Jobs for daily bill reminder checking
- **Notification channels:** Reuse existing notification infrastructure (in-app, email, push)
- **Business day calculations:** Implement holiday calendar with configurable business day logic
- **Escalating urgency:** Multiple reminder stages with increasing notification frequency
- **Payment confirmation:** Integration with transaction creation for payment tracking

## Tasks / Subtasks

### Database Schema Enhancement (AC: 1, 2, 4)
- [ ] **Task 1: Bill Reminder Schema Updates**
  - [ ] Extend `alertType` enum to include bill reminder types ('bill_reminder_1_day', 'bill_reminder_3_day', etc.)
  - [ ] Create bill reminder settings for customizable advance notice periods
  - [ ] Add bill payment status tracking fields to recurring payments table
  - [ ] Generate and test migration scripts for schema updates
  - [ ] Add indexes for efficient bill reminder querying

### Bill Reminder Service Development (AC: 1, 3, 5, 7)
- [ ] **Task 2: Bill Reminder Business Logic** (AC: 1, 3, 7)
  - [ ] Create bill-service.ts following alert-service.ts patterns
  - [ ] Implement due date calculation logic with configurable advance notice
  - [ ] Add business day calculation utilities for weekend/holiday adjustments
  - [ ] Implement escalating reminder logic with multiple notification stages
  - [ ] Add insufficient funds detection logic for upcoming bills
  - [ ] Add comprehensive unit tests for all business logic scenarios

### API Endpoints Development (AC: 2, 4, 6, 8)
- [ ] **Task 3: Bill Management APIs**
  - [ ] Create GET /api/bills endpoint for bill listing and status
  - [ ] Create POST /api/bills for new bill setup
  - [ ] Create PUT /api/bills/[id] for bill updates and reminder settings
  - [ ] Create DELETE /api/bills/[id] for bill deactivation
  - [ ] Create POST /api/bills/[id]/mark-paid for payment confirmation
  - [ ] Create GET /api/bills/reminders for upcoming reminders
  - [ ] Add comprehensive API validation using Zod schemas
  - [ ] Write API endpoint tests

### Cron Job Implementation (AC: 1, 3, 7)
- [ ] **Task 4: Automated Reminder Processing**
  - [ ] Create daily cron job for bill reminder checking
  - [ ] Implement reminder triggering logic with escalating urgency
  - [ ] Add business day adjustment for weekend/holiday due dates
  - [ ] Integrate with existing notification infrastructure from Story 4.1
  - [ ] Test cron job functionality and notification delivery

### Frontend Bill Management (AC: 2, 4, 6, 8)
- [ ] **Task 5: Bill Management Components**
  - [ ] Create BillCenter component for centralized bill management
  - [ ] Create BillSetupForm component for new bill creation and editing
  - [ ] Create BillReminderSettings component for notification preferences
  - [ ] Create PaymentConfirmation component for marking bills as paid
  - [ ] Create UpcomingBills dashboard widget for due date visibility
  - [ ] Implement bill status tracking and payment history display

- [ ] **Task 6: Dashboard Integration** (AC: 4, 5)
  - [ ] Update dashboard-summary.tsx to show upcoming bills widget
  - [ ] Add insufficient funds warnings for upcoming bills
  - [ ] Integrate bill management navigation into main layout
  - [ ] Add visual indicators for overdue and upcoming bills
  - [ ] Integrate with existing alert center for unified notification management

### Multi-channel Notification System (AC: 3, 6)
- [ ] **Task 7: Bill Reminder Notifications**
  - [ ] Extend existing notification provider for bill reminder types
  - [ ] Implement escalating reminder notifications (1, 3, 7, 14 days)
  - [ ] Add customizable notification channel preferences per bill
  - [ ] Integrate with existing in-app, email, and push notification systems
  - [ ] Test notification delivery across all channels and reminder stages

### Payment Tracking Integration (AC: 4, 8)
- [ ] **Task 8: Payment Confirmation and Tracking**
  - [ ] Implement bill payment confirmation from notifications
  - [ ] Add automatic bill status updates when payments are detected
  - [ ] Create payment history tracking for recurring bills
  - [ ] Integrate with transaction creation for payment recording
  - [ ] Add overdue bill detection and notification escalation

### Testing and Quality Assurance (AC: All)
- [ ] **Task 9: Comprehensive Testing**
  - [ ] Write unit tests for bill reminder calculation logic
  - [ ] Write component tests for all bill management UI components
  - [ ] Write integration tests for bill reminder workflow end-to-end
  - [ ] Write API endpoint tests for all bill management endpoints
  - [ ] Test notification delivery and escalation logic
  - [ ] Test business day calculations and holiday adjustments
  - [ ] Test payment confirmation and status tracking
  - [ ] Performance testing for bill reminder processing efficiency

## Testing

### Testing Standards
Following existing test patterns and coverage targets (80%+):
- Test file location: `src/__tests__/`
- Testing frameworks: Vitest + Testing Library for frontend, Vitest + Supertest for backend
- Database testing: Use test database with seed data for bill reminder scenarios
- Mock external services: Email and push notification services, holiday calendar APIs
- Integration testing: Full bill reminder workflow from setup to payment confirmation
- Cron job testing: Mock time-based scenarios for reminder triggering
- Business day calculation testing: Various holiday and weekend scenarios

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-26 | 1.0 | Initial story creation for Epic 4.2 Bill Payment Reminders | Bob (SM) |

## Dev Agent Record

### Agent Model Used
[To be populated by development agent]

### Debug Log References
[To be populated by development agent]

### Completion Notes List
[To be populated by development agent]

### File List
[To be populated by development agent]

## QA Results
[To be populated by QA agent]
