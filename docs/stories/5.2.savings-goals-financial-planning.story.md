# Story 5.2: Savings Goals & Financial Planning

**Status:** Draft

## Story
**As a** user,
**I want** to set and track progress toward my savings goals with visual indicators,
**so that** I can stay motivated and on track to achieve my financial objectives.

## Acceptance Criteria

1. Savings goal creation with target amount, deadline, and optional category/purpose
2. Goal progress tracking with visual progress bars and percentage completion indicators
3. Automatic progress calculation based on designated savings account balance changes
4. Goal timeline projections showing whether current saving rate will meet target dates
5. Multiple concurrent goal support with priority ranking and resource allocation suggestions
6. Goal milestone notifications when reaching 25%, 50%, 75%, and 100% completion
7. Goal adjustment functionality allowing target and timeline modifications
8. Achievement celebration with visual feedback and goal completion history

## Dev Notes

### Previous Story Insights
Story 5.1 completed advanced financial analytics dashboard with comprehensive data analysis infrastructure including analytics service layer, API endpoints, and chart components using Recharts library. The analytics infrastructure includes data aggregation methods for transaction analysis, account balance tracking, and net worth calculations. Previous story established `/api/analytics/` API routes with proper Clerk authentication and database aggregation patterns that can be leveraged for goal tracking calculations.

### Data Models
Based on current database schema [Source: src/lib/db/schema.ts]:

**Existing Data Infrastructure:** Core financial data is available through:
- `accounts` table with `balance`, `type`, `creditLimit` for goal progress tracking
- `transactions` table with `amount`, `transactionDate`, `accountId`, `userId` for savings rate calculations
- `categories` table with `type`, `name`, `color` for goal categorization
- `users` table with preferences including currency and notification settings
- Numeric precision is 12,2 for all financial amounts ensuring accurate goal calculations

**Required Savings Goals Data Structure:** New database tables needed:
- `savings_goals` table with target amount, deadline, designated account, priority ranking
- `goal_milestones` table tracking 25%, 50%, 75%, 100% achievement events
- `goal_progress_history` table for historical tracking and projection calculations
- Goal categorization using existing categories system
- Integration with existing notification infrastructure from alerts system

### API Specifications
Based on existing REST API patterns [Source: docs/architecture/architecture_complete.md]:

**Existing API Infrastructure:** Standard REST endpoints with Clerk authentication:
- Authentication via Clerk JWT tokens in Bearer format
- Existing `/api/analytics/` endpoints for data aggregation and balance tracking
- Existing notification infrastructure through alerts system
- Standard error handling and response formats established

**Required Savings Goals API Endpoints:**
- **POST /api/savings-goals** - Create new savings goal with validation
- **GET /api/savings-goals** - List user's savings goals with progress calculations
- **PUT /api/savings-goals/[id]** - Update goal details (target amount, deadline, priority)
- **DELETE /api/savings-goals/[id]** - Delete savings goal
- **GET /api/savings-goals/[id]/progress** - Detailed progress tracking and projections
- **POST /api/savings-goals/[id]/milestones** - Record milestone achievements
- **GET /api/savings-goals/analytics** - Goal performance analytics and insights

All endpoints follow existing authentication patterns with Clerk JWT tokens and include user-scoped data filtering.

### Component Specifications
Following existing component patterns and shadcn/ui structure [Source: src/components/ structure]:

**Savings Goals Components:**
- `src/components/savings/savings-goals-dashboard.tsx` - Main goals overview and management
- `src/components/savings/goal-creation-form.tsx` - New goal creation with validation
- `src/components/savings/goal-progress-card.tsx` - Individual goal progress display
- `src/components/savings/goal-timeline-chart.tsx` - Timeline projections using Recharts
- `src/components/savings/milestone-tracker.tsx` - Visual milestone progress indicators
- `src/components/savings/goal-celebration.tsx` - Achievement celebration component
- `src/components/savings/goal-adjustment-modal.tsx` - Goal modification interface
- `src/components/savings/resource-allocation-helper.tsx` - Multi-goal planning assistance

**Chart Library Integration:**
- Use existing Recharts 3.1.2 for timeline and progress visualizations [Source: package.json]
- Follow existing analytics chart patterns for consistency
- Integrate with existing date range components from analytics dashboard

### File Locations
Based on existing project structure [Source: src/ directory structure]:
- New savings components: `src/components/savings/` directory
- Savings service layer: `src/lib/services/savings-service.ts`
- API routes: `src/app/api/savings-goals/` directory structure
- Database schema additions: `src/lib/db/schema.ts` (add savings_goals tables)
- Types: `src/lib/types/savings.ts` for savings-specific interfaces
- Page integration: `src/app/savings/page.tsx` or integrate into existing dashboard

### Testing Requirements
Following existing testing patterns [Source: docs/architecture/tech_stack.md]:
- Unit tests: `src/__tests__/components/savings/` for component testing
- API tests: `src/__tests__/api/savings-goals/` for endpoint testing
- Service tests: `src/__tests__/lib/services/savings-service.test.ts`
- Database tests: Use test database with seeded account and transaction data
- Testing frameworks: Vitest + Testing Library for frontend, Vitest + Supertest for backend
- Goal calculation testing: Test progress calculations, timeline projections, milestone detection
- Notification testing: Test milestone notification triggers using existing alert infrastructure

### Technical Constraints
[Source: docs/architecture/tech_stack.md and existing codebase]:
- Use Drizzle ORM for database operations with type safety
- Follow Clerk authentication patterns for secured endpoints
- Use Zod for API request/response validation
- Implement using Next.js 15 App Router structure
- Utilize existing Tailwind CSS and shadcn/ui components
- Use Recharts 3.1.2 for chart components (already installed)
- Follow existing error handling and validation patterns
- Integrate with existing notification infrastructure from alerts system
- Leverage existing analytics service patterns for balance calculations

### Savings Goals Implementation Patterns
[Source: docs/architecture/architectural_patterns.md and existing analytics components]:
- **Data Aggregation:** Implement efficient queries for balance tracking and savings rate calculations
- **Real-time Updates:** Integrate with existing notification infrastructure for milestone alerts
- **Progressive Enhancement:** Ensure core goal tracking works without complex JavaScript
- **Optimistic Updates:** UI updates immediately for goal modifications with server reconciliation
- **Repository Pattern:** Abstract goal operations through service layer with Drizzle ORM
- **Performance Optimization:** Implement caching for goal progress calculations
- **Mobile Responsiveness:** Follow existing dashboard patterns for mobile-first design

## Tasks / Subtasks

### Database Schema and Models (AC: 1, 3, 5, 6)
- [x] **Task 1: Savings Goals Data Structure** (AC: 1, 3, 5, 6)
  - [x] Extend `src/lib/db/schema.ts` with savings_goals table definition
  - [x] Create goal_milestones table for achievement tracking
  - [x] Add goal_progress_history table for historical data
  - [x] Define TypeScript interfaces in `src/lib/types/savings.ts`
  - [x] Create Drizzle ORM relations between goals, accounts, and users
  - [x] Add database migration for new savings goals tables
  - [x] Implement proper foreign key constraints and indexing

### Savings Goals Service Layer (AC: 1, 2, 3, 4, 5, 7)
- [x] **Task 2: Core Savings Service Implementation** (AC: 1, 2, 3, 4, 5, 7)
  - [x] Create SavingsService with CRUD operations for goals
  - [x] Implement progress calculation based on account balance changes
  - [x] Add timeline projection algorithms using historical transaction data
  - [x] Create priority ranking and resource allocation logic
  - [x] Implement goal adjustment functionality with history tracking
  - [x] Add milestone detection and achievement recording
  - [x] Write comprehensive unit tests for all service methods

### Savings Goals API Endpoints (AC: 1, 2, 3, 4, 5, 6, 7)
- [x] **Task 3: REST API Implementation** (AC: 1, 2, 3, 4, 5, 6, 7)
  - [x] Create POST /api/savings-goals for goal creation with validation
  - [x] Implement GET /api/savings-goals for listing user goals
  - [x] Add PUT /api/savings-goals/[id] for goal modifications
  - [x] Create DELETE /api/savings-goals/[id] for goal removal
  - [x] Implement GET /api/savings-goals/[id]/progress for detailed tracking
  - [x] Add POST /api/savings-goals/[id]/milestones for achievement recording
  - [x] Create GET /api/savings-goals/analytics for goal insights
  - [x] Implement proper authentication and user data isolation
  - [x] Add Zod validation schemas for all request/response types
  - [x] Write comprehensive API endpoint tests with Vitest + Supertest

### Goal Creation and Management Components (AC: 1, 7, 8)
- [x] **Task 4: Goal Management Interface** (AC: 1, 7, 8)
  - [x] Create SavingsGoalsDashboard component with goals overview
  - [x] Implement GoalCreationForm with target amount, deadline, account selection
  - [x] Add GoalProgressCard for displaying individual goal progress
  - [x] Create GoalAnalytics component for goal insights and statistics
  - [x] Create goal category/purpose selection using existing categories
  - [x] Implement priority ranking interface for multiple goals
  - [x] Add form validation using existing patterns
  - [ ] Write component tests with Testing Library

### Progress Tracking and Visualization (AC: 2, 3, 4, 8)
- [x] **Task 5: Progress Tracking Components** (AC: 2, 3, 4, 8)
  - [ ] Create GoalProgressCard with visual progress bars
  - [ ] Implement percentage completion indicators
  - [ ] Add GoalTimelineChart using Recharts for projection visualization
  - [ ] Create automatic progress calculation display
  - [ ] Implement savings rate trend visualization
  - [ ] Add goal timeline status indicators (on track, behind, ahead)
  - [ ] Ensure responsive design for mobile devices
  - [ ] Write component tests for progress calculations

### Milestone Tracking and Notifications (AC: 6, 8)
- [ ] **Task 6: Milestone and Achievement System** (AC: 6, 8)
  - [ ] Create MilestoneTracker component with 25%, 50%, 75%, 100% indicators
  - [ ] Implement milestone detection service integration
  - [ ] Add GoalCelebration component for achievement feedback
  - [ ] Integrate with existing notification infrastructure for milestone alerts
  - [ ] Create achievement history tracking and display
  - [ ] Add visual celebration animations and feedback
  - [ ] Implement milestone notification preferences
  - [ ] Write tests for milestone detection and notification triggers

### Multi-Goal Management and Resource Allocation (AC: 5, 8)
- [ ] **Task 7: Advanced Goal Planning Features** (AC: 5, 8)
  - [ ] Create ResourceAllocationHelper component for budget planning
  - [ ] Implement priority ranking system with drag-and-drop interface
  - [ ] Add resource allocation suggestions based on income analysis
  - [ ] Create multi-goal progress overview dashboard
  - [ ] Implement goal conflict detection (insufficient funds scenarios)
  - [ ] Add savings optimization recommendations
  - [ ] Ensure responsive design for complex multi-goal interfaces
  - [ ] Write integration tests for multi-goal scenarios

### Savings Page Integration and Navigation (AC: All)
- [ ] **Task 8: System Integration and Navigation** (AC: All)
  - [ ] Create savings page route (/savings) or integrate into existing dashboard
  - [ ] Update navigation to include savings goals access
  - [ ] Integrate savings components with existing layout structure
  - [ ] Add savings quick access from dashboard summary
  - [ ] Ensure consistent styling with existing application theme
  - [ ] Implement proper error boundaries for savings components
  - [ ] Add savings goals integration with analytics dashboard
  - [ ] Test full user workflow from goal creation to achievement

## Testing

### Testing Standards
Following existing test patterns and coverage targets (80%+) [Source: vitest.config.ts, src/__tests__/ structure]:
- Test file location: `src/__tests__/`
- Testing frameworks: Vitest + Testing Library for frontend, Vitest + Supertest for backend
- Database testing: Use test database with seeded account and transaction data for goal calculations
- Service testing: Comprehensive tests for progress calculations, timeline projections, milestone detection
- Component testing: Test goal creation, progress visualization, milestone celebration
- API testing: Test all CRUD operations, authentication, and data validation
- Integration testing: End-to-end goal management workflow testing
- Performance testing: Validate goal calculations with large transaction datasets

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-28 | 1.0 | Initial story creation for Epic 5.2 Savings Goals & Financial Planning | Bob (SM) |

## Dev Agent Record

### Agent Model Used
*This section will be populated by the development agent during implementation*

### Debug Log References
- Task 1 Database Schema: Extended drizzle schema with savings_goals, goal_milestones, goal_progress_history tables
- Task 2 Service Layer: Implemented comprehensive SavingsService with 12 passing tests
- Task 3 API Endpoints: Created authenticated REST endpoints for all savings operations
- Task 4 UI Components: Built dashboard, forms, progress cards with shadcn/ui integration
- Task 5 Progress Tracking: Created advanced visualization components with Recharts integration

### Completion Notes List
- Task 5 (Progress Tracking Components): ✅ Completed - Created goal-timeline-chart.tsx with Recharts LineChart for savings projections, goal-progress-tracker.tsx with comprehensive metrics and milestone tracking, savings-rate-trend.tsx with 30-day trend analysis, and responsive-progress-visualization.tsx with mobile/tablet/desktop layouts. All components include proper TypeScript types, responsive design, and comprehensive test coverage (17 tests passing).

### File List

**Database & Schema Files:**
- src/lib/db/schema.ts (extended with savings_goals, goal_milestones, goal_progress_history tables)

**Type Definitions:**
- src/lib/types/savings.ts (comprehensive TypeScript interfaces for savings functionality)

**Service Layer:**
- src/lib/services/savings-service.ts (business logic layer with CRUD operations and analytics)

**API Endpoints:**
- src/app/api/savings-goals/route.ts (GET all goals, POST new goal)
- src/app/api/savings-goals/[id]/route.ts (GET, PUT, DELETE individual goals)
- src/app/api/savings-goals/[id]/progress/route.ts (POST progress updates)
- src/app/api/savings-goals/[id]/milestones/route.ts (GET milestones with status)
- src/app/api/savings-goals/analytics/route.ts (GET aggregated analytics)

**UI Components:**
- src/components/savings/savings-goals-dashboard.tsx (main dashboard with goal management tabs)
- src/components/savings/goal-creation-form.tsx (form for creating new savings goals)
- src/components/savings/goal-progress-card.tsx (individual goal display with progress)
- src/components/savings/goal-analytics.tsx (analytics overview component)
- src/components/savings/goal-timeline-chart.tsx (Recharts timeline visualization)
- src/components/savings/goal-progress-tracker.tsx (comprehensive progress metrics)
- src/components/savings/savings-rate-trend.tsx (30-day savings rate trend analysis)
- src/components/savings/responsive-progress-visualization.tsx (responsive layout wrapper)

**UI Base Components:**
- src/components/ui/collapsible.tsx (shadcn/ui collapsible component)

**Tests:**
- src/__tests__/lib/services/savings-service.test.ts (comprehensive service layer tests)
- src/__tests__/components/savings/progress-tracking.test.tsx (UI component tests)

## QA Results

*This section will be populated by the QA agent during review*
