# Story 4.3: Recurring Payment Management

**Status:** ready

## Story
**As a** user,
**I want** the system to detect and manage my recurring payments automatically,
**so that** I can track subscription costs and recurring expenses without manual entry for each occurrence.

## Acceptance Criteria

1. Automatic detection of recurring payment patterns from transaction history analysis
2. Recurring payment setup with frequency, amount, category, and next expected date
3. Automated transaction creation for confirmed recurring payments with user approval options
4. Recurring payment dashboard showing all subscriptions, memberships, and regular bills
5. Cost analysis showing monthly, quarterly, and annual recurring payment totals
6. Missed recurring payment detection with notifications for expected but missing transactions
7. Recurring payment modification allowing amount updates, frequency changes, and cancellation tracking
8. Integration with budgeting features showing recurring payment impact on available spending

## Dev Notes

### Previous Story Insights
Story 4.2 (Bill Payment Reminders) established comprehensive bill reminder infrastructure including multi-channel notification systems, bill service patterns, and automated cron job processing. The infrastructure includes the `recurringPayments` table foundation, notification provider components, and bill management API endpoints that provide the core data models and service patterns needed for recurring payment detection and automation. The existing BillService contains methods for bill payment detection and tracking that can be leveraged for recurring payment pattern analysis.

### Data Models
Based on the current database schema [Source: src/lib/db/schema.ts]:

**Existing Recurring Payments Foundation:** The `recurringPayments` table provides core infrastructure:
- `id: uuid` - Unique recurring payment identifier
- `userId: text` - Payment owner for user-scoped data
- `accountId: uuid` - Account charged for recurring payment
- `name: text` - Payment name (e.g., "Netflix Subscription", "Electric Bill")
- `amount: numeric` - Expected payment amount with financial precision
- `frequency: paymentFrequencyEnum` - Payment frequency (weekly, monthly, quarterly, yearly)
- `nextDueDate: timestamp` - Next expected payment date for automation calculations
- `categoryId: uuid` - Category for automatic transaction categorization
- `isActive: boolean` - Whether recurring payment is still active
- `lastProcessed: timestamp` - Last time payment was detected/processed
- `status: billStatusEnum` - Payment status (pending, paid, overdue, cancelled)
- `paymentDate: timestamp` - Actual payment date when detected
- `reminderDays: text` - CSV of reminder advance days for notifications

**Transaction Pattern Analysis Requirements:**
- Leverage existing `transactions` table for pattern detection
- Analyze transaction history by amount, description, account, and date patterns
- Use transaction categorization for automatic recurring payment category assignment
- Integrate with existing transaction creation workflows

**Recurring Payment Detection Algorithm Data:**
- Transaction frequency analysis (weekly, monthly, quarterly, yearly patterns)
- Amount consistency thresholds for payment identification
- Merchant name pattern matching for subscription detection
- Date variance tolerance for irregular payment schedules

### API Specifications
Based on existing API patterns [Source: docs/architecture/architecture.md#api-specification]:

**Existing Infrastructure from Story 4.2:**
- **GET /api/bills** - Can be extended for recurring payment retrieval with filtering
- **POST /api/bills** - Can support recurring payment creation workflow
- **PUT /api/bills/[id]** - Pattern for recurring payment updates

**New Recurring Payment API Endpoints:**
- **GET /api/recurring-payments** - Retrieve user's recurring payments with filtering and analysis
- **POST /api/recurring-payments** - Create new recurring payment from manual setup or detected pattern
- **PUT /api/recurring-payments/[id]** - Update recurring payment details, frequency, and settings
- **DELETE /api/recurring-payments/[id]** - Cancel/deactivate recurring payment
- **POST /api/recurring-payments/detect** - Trigger recurring payment pattern detection from transaction history
- **GET /api/recurring-payments/analysis** - Get cost analysis and spending impact data
- **POST /api/recurring-payments/[id]/confirm** - Confirm detected pattern as actual recurring payment
- **GET /api/recurring-payments/missed** - Get missed or overdue recurring payments

Authentication via Clerk JWT tokens following existing pattern [Source: docs/architecture/architecture.md#api-specification]

### Component Specifications
Following existing component patterns and bill management infrastructure [Source: src/components/bills/ structure]:

**Recurring Payment Management Components:**
- `src/components/recurring-payments/recurring-payment-center.tsx` - Main recurring payment dashboard
- `src/components/recurring-payments/payment-detection-panel.tsx` - Pattern detection and confirmation interface
- `src/components/recurring-payments/recurring-payment-setup-form.tsx` - Manual recurring payment creation form
- `src/components/recurring-payments/cost-analysis-dashboard.tsx` - Cost analysis and spending impact visualization
- `src/components/recurring-payments/missed-payments-alert.tsx` - Missed payment detection and notifications

**Integration Points:**
- Extend existing `src/components/dashboard/dashboard-summary.tsx` to show recurring payment insights
- Leverage `src/components/bills/bill-center.tsx` patterns for consistent bill management UI
- Integrate with existing `src/lib/services/bill-service.ts` for payment detection logic
- Use existing notification infrastructure from `src/components/alerts/notification-provider.tsx`

### File Locations
Based on existing project structure and bill management patterns [Source: src/ directory structure]:
- Database schema enhancements: Already implemented in `src/lib/db/schema.ts`
- New service layer: `src/lib/services/recurring-payment-service.ts` (following bill-service.ts patterns)
- API routes: `src/app/api/recurring-payments/` directory structure
- Components: `src/components/recurring-payments/` directory
- Utilities: `src/lib/utils/recurring-payment-utils.ts` for pattern detection algorithms
- Types: Leverage existing types in `src/lib/db/schema.ts` for RecurringPayment interfaces

### Testing Requirements
Following existing testing patterns [Source: src/__tests__/ structure]:
- Unit tests: `src/__tests__/components/recurring-payments/` for component testing
- API tests: `src/__tests__/api/recurring-payments/` for endpoint testing
- Service tests: `src/__tests__/lib/services/recurring-payment-service.test.ts`
- Utility tests: `src/__tests__/lib/utils/recurring-payment-utils.test.ts` for detection algorithms
- Integration tests for end-to-end recurring payment detection and automation workflows

### Technical Constraints
[Source: docs/architecture/architecture.md#tech-stack]:
- Use Drizzle ORM for database operations with type safety
- Follow Clerk authentication patterns for secured endpoints
- Use Zod for API request/response validation
- Implement using Next.js 15 App Router structure
- Utilize existing Tailwind CSS and shadcn/ui components
- Use Decimal.js or numeric precision for financial calculations
- Follow existing error handling and validation patterns
- Leverage React Query patterns established in Story 4.2

### Recurring Payment Detection Implementation
[Source: docs/architecture/architectural_patterns.md and existing service patterns]:
- **Pattern Analysis:** Implement transaction history analysis using existing transaction data structures
- **Machine Learning-Ready:** Design detection algorithms to be ML-enhancement ready for future improvements
- **Automated Transaction Creation:** Leverage existing transaction creation patterns for automated payment recording
- **User Confirmation Workflow:** Implement user approval system for detected patterns before automation
- **Cost Impact Analysis:** Provide spending impact analysis using existing financial calculation utilities

## Tasks / Subtasks

### Recurring Payment Detection Service Development (AC: 1, 6)
- [ ] **Task 1: Pattern Detection Algorithm Implementation** (AC: 1)
  - [ ] Create recurring-payment-service.ts following existing bill-service.ts patterns
  - [ ] Implement transaction pattern analysis algorithm for frequency detection (weekly, monthly, quarterly, yearly)
  - [ ] Add amount consistency analysis with configurable tolerance thresholds
  - [ ] Implement merchant name pattern matching for subscription identification
  - [ ] Add date variance analysis for detecting irregular but recurring payment schedules
  - [ ] Create pattern confidence scoring system for detection reliability
  - [ ] Add comprehensive unit tests for all detection algorithms

### API Endpoints Development (AC: 1, 2, 3, 7)
- [ ] **Task 2: Recurring Payment Management APIs**
  - [ ] Create GET /api/recurring-payments endpoint for recurring payment listing with filtering
  - [ ] Create POST /api/recurring-payments for manual recurring payment creation
  - [ ] Create PUT /api/recurring-payments/[id] for recurring payment updates and modifications
  - [ ] Create DELETE /api/recurring-payments/[id] for recurring payment cancellation
  - [ ] Create POST /api/recurring-payments/detect for triggering pattern detection analysis
  - [ ] Create POST /api/recurring-payments/[id]/confirm for confirming detected payment patterns
  - [ ] Add comprehensive API validation using Zod schemas
  - [ ] Write API endpoint tests covering success paths, error cases, and validation scenarios

### Cost Analysis and Reporting (AC: 4, 5, 8)
- [ ] **Task 3: Recurring Payment Analysis APIs**
  - [ ] Create GET /api/recurring-payments/analysis endpoint for cost analysis and spending impact
  - [ ] Create GET /api/recurring-payments/missed endpoint for missed payment detection
  - [ ] Implement monthly, quarterly, and annual cost calculation logic
  - [ ] Add spending impact analysis showing budget allocation for recurring payments
  - [ ] Create recurring payment trend analysis with growth/decline detection
  - [ ] Add comprehensive testing for analysis calculations and edge cases

### Automated Transaction Creation System (AC: 3, 6)
- [ ] **Task 4: Payment Automation and Confirmation**
  - [ ] Implement automated transaction creation for confirmed recurring payments
  - [ ] Add user approval workflow for detected recurring payment patterns
  - [ ] Create missed payment detection system with notification integration
  - [ ] Implement recurring payment processing logic with failure handling
  - [ ] Add payment confirmation and status update mechanisms
  - [ ] Integrate with existing notification infrastructure for missed payment alerts
  - [ ] Add comprehensive testing for automation workflows and error scenarios

### Frontend Recurring Payment Management (AC: 2, 4, 7)
- [ ] **Task 5: Recurring Payment Management Components**
  - [ ] Create RecurringPaymentCenter component for centralized management dashboard
  - [ ] Create PaymentDetectionPanel component for pattern detection and confirmation interface
  - [ ] Create RecurringPaymentSetupForm component for manual payment setup
  - [ ] Create CostAnalysisDashboard component for spending impact visualization
  - [ ] Create MissedPaymentsAlert component for overdue payment notifications
  - [ ] Implement recurring payment modification functionality with frequency and amount updates

### Dashboard Integration and Analytics (AC: 4, 5, 8)
- [ ] **Task 6: Dashboard Integration and Cost Visualization**
  - [ ] Update dashboard-summary.tsx to show recurring payment insights and cost breakdown
  - [ ] Add recurring payment cost widgets with monthly/quarterly/annual totals
  - [ ] Create recurring payment trend charts showing payment history and projections
  - [ ] Add spending impact visualization showing budget allocation for recurring payments
  - [ ] Integrate with existing dashboard layout and navigation patterns
  - [ ] Add React Query integration for efficient client-side data management

### Notification Integration (AC: 6)
- [ ] **Task 7: Missed Payment Detection and Notifications**
  - [ ] Extend existing notification infrastructure for recurring payment alerts
  - [ ] Implement missed payment detection logic with configurable tolerance periods
  - [ ] Add escalating notification system for overdue recurring payments
  - [ ] Integrate with existing multi-channel notification system (in-app, email, push)
  - [ ] Add recurring payment reminder system for upcoming expected payments
  - [ ] Test notification delivery and escalation logic across all channels

### Budget Integration and Spending Impact (AC: 8)
- [ ] **Task 8: Budget Integration and Spending Analysis**
  - [ ] Implement recurring payment impact analysis on available spending budget
  - [ ] Add recurring payment allocation visualization in budget breakdown
  - [ ] Create spending projection analysis including recurring payment obligations
  - [ ] Integrate with existing financial calculation utilities for accuracy
  - [ ] Add budget vs actual recurring payment comparison analysis
  - [ ] Implement spending optimization suggestions based on recurring payment analysis

### Testing and Quality Assurance (AC: All)
- [ ] **Task 9: Comprehensive Testing**
  - [ ] Write unit tests for recurring payment detection algorithms and pattern matching
  - [ ] Write component tests for all recurring payment management UI components
  - [ ] Write integration tests for end-to-end recurring payment workflow
  - [ ] Write API endpoint tests for all recurring payment management endpoints
  - [ ] Test automated transaction creation and user confirmation workflows
  - [ ] Test cost analysis calculations and spending impact accuracy
  - [ ] Test missed payment detection and notification escalation
  - [ ] Performance testing for pattern detection algorithms with large transaction datasets

## Testing

### Testing Standards
Following existing test patterns and coverage targets (80%+) [Source: vitest.config.ts, src/__tests__/ structure]:
- Test file location: `src/__tests__/`
- Testing frameworks: Vitest + Testing Library for frontend, Vitest + Supertest for backend
- Database testing: Use test database with seed data for recurring payment detection scenarios
- Mock external services: Email and push notification services, transaction processing
- Integration testing: Full recurring payment workflow from detection to confirmation
- Algorithm testing: Comprehensive testing of pattern detection with various transaction scenarios
- Performance testing: Pattern detection efficiency with large datasets

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-27 | 1.0 | Initial story creation for Epic 4.3 Recurring Payment Management | Bob (SM) |

## Dev Agent Record

### Agent Model Used
*This section will be populated by the development agent during implementation*

### Debug Log References
*This section will be populated by the development agent during implementation*

### Completion Notes List
*This section will be populated by the development agent during implementation*

### File List
*This section will be populated by the development agent during implementation*

## QA Results

*This section will be populated by the QA agent during story review*
