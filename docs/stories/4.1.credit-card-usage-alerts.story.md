# Story 4.1: Credit Card Usage Alerts

**Status:** ready

## Story
**As a** user,
**I want** to receive automated alerts when my credit card usage approaches preset thresholds,
**so that** I can avoid overspending and maintain healthy credit utilization ratios.

## Acceptance Criteria

1. Automated alerts triggered when credit card usage reaches 30%, 50%, 70%, and 90% of credit limit
2. Customizable alert thresholds per credit card with user-defined percentages and dollar amounts
3. Multiple notification channels: in-app notifications, email alerts, and browser push notifications
4. Alert history tracking showing all triggered alerts with timestamps and actions taken
5. Smart alert timing avoids spam by implementing minimum intervals between similar alerts
6. Visual dashboard indicators showing current utilization status with color-coded warnings
7. Alert acknowledgment system allowing users to dismiss or snooze notifications
8. Integration with transaction entry to trigger real-time alerts on new credit card transactions

## Dev Notes

### Previous Story Insights
Story 3.2 implemented enhanced transaction entry with currency conversion to INR and transaction categorization. The system now supports advanced transaction features including splitting, templates, and bulk entry. This story builds upon the existing transaction and account management foundation to add proactive financial monitoring.

### Data Models
Based on the current database schema [Source: src/lib/db/schema.ts]:

**Account Data Model:** Credit card accounts use the `accounts` table with:
- `type: 'credit_card'` to identify credit card accounts
- `balance: numeric` representing current balance (negative for credit cards indicating debt)
- `creditLimit: numeric` representing the credit limit for calculations
- `userId: text` for user association

**User Preferences:** The existing `UserPreferences` interface includes:
- `alertThresholds.creditCard: number` (currently defaulting to 80% threshold)
- `notifications.email: boolean`, `notifications.push: boolean` for notification preferences

**New Alert System Data Model Required:**
- Alert tracking table to store alert history
- Alert acknowledgment tracking
- Customizable threshold settings per account

### API Specifications
New API endpoints needed [Source: docs/architecture/architecture.md#api-specification]:

**GET /api/alerts** - Retrieve user's alert history and current status
**POST /api/alerts/settings** - Update alert threshold settings for specific accounts
**POST /api/alerts/acknowledge** - Mark alerts as acknowledged/dismissed
**GET /api/accounts/utilization** - Get current credit utilization data for dashboard

Authentication via Clerk JWT tokens following existing pattern [Source: docs/architecture/architecture.md#api-specification]

### Component Specifications
Following existing component patterns [Source: existing component structure]:

**Alert Dashboard Components:**
- `src/components/alerts/alert-center.tsx` - Main alert dashboard component
- `src/components/alerts/alert-settings.tsx` - Threshold configuration component
- `src/components/alerts/utilization-indicator.tsx` - Visual utilization display
- `src/components/alerts/alert-notification.tsx` - In-app notification component

**Integration Points:**
- Update `src/components/dashboard/account-balance-summary.tsx` to show utilization warnings
- Enhance `src/components/transactions/transaction-create-form.tsx` to trigger real-time alerts
- Add alert menu/indicator to main navigation layout

### File Locations
Based on existing project structure:
- Database schema updates: `src/lib/db/schema.ts`
- New migration: `drizzle/migrations/` for alert tables
- API routes: `src/app/api/alerts/` directory
- Alert services: `src/lib/services/alert-service.ts`
- Alert components: `src/components/alerts/` directory
- Alert utilities: `src/lib/utils/alert-utils.ts`

### Testing Requirements
Following existing testing patterns [Source: src/__tests__/ structure]:
- Unit tests: `src/__tests__/components/alerts/` for component testing
- API tests: `src/__tests__/api/alerts/` for endpoint testing
- Service tests: `src/__tests__/lib/services/alert-service.test.ts`
- Utility tests: `src/__tests__/lib/utils/alert-utils.test.ts`
- Integration tests for alert triggering workflows

### Technical Constraints
[Source: docs/architecture/architecture.md#tech-stack]:
- Use Drizzle ORM for database operations with type safety
- Follow Clerk authentication patterns for secured endpoints
- Use Zod for API request/response validation
- Implement using Next.js 15 App Router structure
- Utilize existing Tailwind CSS and shadcn/ui components
- Use Decimal.js or numeric precision for financial calculations
- Follow existing error handling and validation patterns

### Notification Implementation
[Source: docs/architecture/architecture.md#platform-infrastructure]:
- **In-app notifications:** React state management with toast notifications using existing toast system
- **Email notifications:** Integration with Vercel's email capabilities or third-party service
- **Push notifications:** Browser push API for PWA capabilities mentioned in architecture
- **Cron jobs:** Utilize Vercel Cron Jobs for periodic alert checking

## Tasks / Subtasks

### Core Alert Infrastructure (AC: 1, 5)
- [x] **Task 1: Database Schema Enhancement**
  - [x] Create alerts table for tracking alert history and acknowledgments
  - [x] Create alert_settings table for per-account customizable thresholds
  - [x] Add indexes for efficient alert querying by user and account
  - [x] Generate and test migration scripts

- [x] **Task 2: Alert Calculation Service** (AC: 1, 2)
  - [x] Create alert-service.ts with credit utilization calculation logic
  - [x] Implement threshold checking for 30%, 50%, 70%, 90% default levels
  - [x] Add support for custom user-defined percentage and dollar amount thresholds
  - [x] Implement smart timing logic to prevent alert spam (minimum intervals)
  - [x] Add unit tests for all calculation scenarios

### API Endpoints Development (AC: 1, 2, 4, 7)
- [x] **Task 3: Alert Management APIs**
  - [x] Create GET /api/alerts endpoint for alert history retrieval
  - [x] Create POST /api/alerts/settings for threshold configuration
  - [x] Create POST /api/alerts/acknowledge for alert dismissal/snoozing
  - [x] Create GET /api/accounts/utilization for real-time utilization data
  - [x] Add comprehensive API validation using Zod schemas
  - [x] Write API endpoint tests

### Real-time Alert Triggering (AC: 1, 8)
- [x] **Task 4: Transaction Integration**
  - [x] Modify transaction creation to trigger utilization checks for credit cards
  - [x] Add alert triggering logic to transaction API endpoints
  - [x] Implement real-time alert generation on transaction submission
  - [x] Test alert triggering across different transaction scenarios

### Frontend Alert System (AC: 3, 6, 7)
- [x] **Task 5: Alert Dashboard Components**
  - [x] Create AlertCenter component for centralized alert management
  - [x] Create UtilizationIndicator component with color-coded warnings
  - [x] Create AlertSettings component for threshold customization
  - [x] Create AlertNotification component for in-app notifications
  - [x] Implement alert acknowledgment and dismissal functionality

- [ ] **Task 6: Dashboard Integration** (AC: 6)
  - [ ] Update account-balance-summary.tsx to show utilization warnings
  - [ ] Add visual indicators (color coding) for different alert levels
  - [ ] Integrate alert status into main dashboard layout
  - [ ] Add navigation to alert center from main navigation

### Notification Channels (AC: 3)
- [ ] **Task 7: Multi-channel Notification System**
  - [ ] Implement in-app toast notifications for immediate alerts
  - [ ] Set up email notification system for alert delivery
  - [ ] Implement browser push notifications for PWA capabilities
  - [ ] Add user preference controls for notification channel selection
  - [ ] Test notification delivery across all channels

### Testing and Quality Assurance (AC: All)
- [ ] **Task 8: Comprehensive Testing**
  - [ ] Write unit tests for alert calculation logic
  - [ ] Write component tests for all alert UI components
  - [ ] Write integration tests for alert triggering workflows
  - [ ] Write API endpoint tests for all alert endpoints
  - [ ] Test notification delivery and user preference handling
  - [ ] Test alert history tracking and acknowledgment system
  - [ ] Performance testing for alert calculation efficiency

## Testing

### Testing Standards
Following existing test patterns and coverage targets (80%+):
- Test file location: `src/__tests__/`
- Testing frameworks: Vitest + Testing Library for frontend, Vitest + Supertest for backend
- Database testing: Use test database with seed data for alert scenarios
- Mock external services: Email and push notification services
- Integration testing: Full alert workflow from transaction to notification delivery

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-16 | 1.0 | Initial story creation for Epic 4.1 Credit Card Usage Alerts | Bob (SM) |

## Dev Agent Record

### Agent Model Used
gpt-4-turbo via VS Code (James - Full Stack Developer Agent)

### Debug Log References
- Database schema migration: drizzle migrations 0002_ambiguous_titania.sql, 0003_sturdy_grandmaster.sql
- Alert service implementation: src/lib/services/alert-service.ts
- Test suite validation: src/__tests__/lib/services/alert-service.test.ts

### Completion Notes List
- Task 1 ✅: Database schema enhanced with alerts and alert_settings tables, indexes created
- Task 2 ✅: Alert calculation service implemented with comprehensive business logic and tests
- Task 3 ✅: API endpoints created for alert management, settings, and utilization data
- Task 4 ✅: Transaction integration completed with real-time alert triggering
- Task 5 ✅: Frontend alert components created with comprehensive UI functionality
- Database migrations successfully applied to NeonDB with proper indexes for performance
- Alert service includes spam prevention, credit utilization calculations, and CRUD operations
- All 16 unit tests passing for alert service, covering utilization calculations, threshold checking, and alert management
- 8 API tests passing, validating endpoint structure and validation logic
- Complete API layer: GET /api/alerts, POST /api/alerts/acknowledge, POST /api/alerts/snooze, POST /api/alerts/dismiss, GET/POST /api/alerts/settings, GET /api/accounts/utilization
- Transaction endpoints integrated with AlertService for real-time credit card utilization monitoring
- Frontend components include AlertCenter, UtilizationIndicator, AlertSettings, and AlertNotification with full interactivity

### File List
**Created Files:**
- src/lib/services/alert-service.ts - Alert business logic service
- src/__tests__/lib/services/alert-service.test.ts - Comprehensive test suite
- src/__tests__/api/alerts.test.ts - API endpoint validation tests
- src/app/api/alerts/route.ts - Alert history retrieval endpoint
- src/app/api/alerts/acknowledge/route.ts - Alert acknowledgment endpoint
- src/app/api/alerts/snooze/route.ts - Alert snooze endpoint
- src/app/api/alerts/dismiss/route.ts - Alert dismissal endpoint
- src/app/api/alerts/settings/route.ts - Alert settings management endpoint
- src/app/api/accounts/utilization/route.ts - Credit utilization data endpoint
- src/components/alerts/alert-center.tsx - Centralized alert management component
- src/components/alerts/utilization-indicator.tsx - Credit utilization visual indicator
- src/components/alerts/alert-settings.tsx - Alert threshold configuration component
- src/components/alerts/alert-notification.tsx - In-app notification component
- src/components/alerts/index.ts - Alert components export file
- src/components/ui/alert.tsx - Base alert UI component
- src/components/ui/switch.tsx - Switch UI component
- drizzle/migrations/0002_ambiguous_titania.sql - Alert tables migration
- drizzle/migrations/0003_sturdy_grandmaster.sql - Alert indexes migration

**Modified Files:**
- src/lib/db/schema.ts - Added alerts, alertSettings tables with enums and relations
- src/app/api/transactions/route.ts - Added alert triggering to transaction creation
- src/app/api/transactions/[id]/route.ts - Added alert triggering to transaction updates/deletions
- drizzle/migrations/meta/_journal.json - Migration metadata
- drizzle/migrations/meta/0002_snapshot.json - Schema snapshot
- drizzle/migrations/meta/0003_snapshot.json - Schema snapshot with indexes

## QA Results
<!-- To be filled by QA agent after implementation review -->
